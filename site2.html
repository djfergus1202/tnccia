<script type="module">
    // =====================================
    // Firebase Imports
    // =====================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        onSnapshot,
        updateDoc,
        getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener("DOMContentLoaded", () => {
        // =====================================
        // Firebase Configuration & Init
        // =====================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // <<<<<<<<<<<<<<<<<<<
            authDomain: "YOUR_AUTH_DOMAIN", // <<<<<<<<<<<<<
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Warn if not configured, but do NOT return!
        if (firebaseConfig.apiKey.startsWith("YOUR_")) {
            console.error("âŒ Please replace the Firebase config placeholders with your real values.");
            // NO RETURN HERE
        }

        // Initialize Firebase regardless
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // =====================================
        // UI References
        // =====================================
        const authPage      = document.getElementById("auth-page");
        const mainApp       = document.getElementById("main-app");
        const loadingOverlay= document.getElementById("loading-overlay");
        const tabLogin      = document.getElementById("tab-login");
        const tabSignup     = document.getElementById("tab-signup");
        const formLogin     = document.getElementById("form-login");
        const formSignup    = document.getElementById("form-signup");
        const errorLogin    = document.getElementById("error-login");
        const errorSignup   = document.getElementById("error-signup");
        const signOutBtn    = document.getElementById("sign-out-btn");
        const adminBtn      = document.getElementById("admin-btn");
        const sidebarBtns   = document.querySelectorAll("#sidebar .nav-button");
        const sections      = document.querySelectorAll(".content-section");
        const strategyInput = document.getElementById("strategy-input");
        const postBtn       = document.getElementById("strategy-post-btn");
        const feedContainer = document.getElementById("strategy-feed");
        const openMapBtn    = document.getElementById("open-map-btn");
        const mapModal      = document.getElementById("mind-map-modal");
        const closeMapBtn   = document.getElementById("close-map-btn");
        const mapContainer  = document.getElementById("mind-map-container");
        const openAdminBtn  = document.getElementById("open-admin-btn");
        const adminModal    = document.getElementById("admin-modal");
        const closeAdminBtn = document.getElementById("close-admin-btn");
        const adminList     = document.getElementById("admin-user-list");

        // =====================================
        // Auth Form Tab Logic
        // =====================================
        function showLoginTab() {
            tabLogin.classList.add("active");
            tabSignup.classList.remove("active");
            formLogin.classList.remove("hidden");
            formSignup.classList.add("hidden");
            errorLogin.textContent = "";
        }
        function showSignupTab() {
            tabSignup.classList.add("active");
            tabLogin.classList.remove("active");
            formSignup.classList.remove("hidden");
            formLogin.classList.add("hidden");
            errorSignup.textContent = "";
        }
        tabLogin.addEventListener("click", showLoginTab);
        tabSignup.addEventListener("click", showSignupTab);

        // =====================================
        // Registration Handler
        // =====================================
        formSignup.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorSignup.textContent = "";
            const name     = document.getElementById("signup-name").value.trim();
            const email    = document.getElementById("signup-email").value.trim();
            const password = document.getElementById("signup-password").value;
            const headline = document.getElementById("signup-headline").value.trim();
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                const uid = cred.user.uid;
                await setDoc(doc(db, "users", uid), {
                    fullName: name,
                    email: email,
                    headline: headline,
                    avatarUrl: `https://i.pravatar.cc/150?u=${uid}`
                });
                await setDoc(doc(db, "users", uid, "data", "mindMap"), { nodes: [], connections: [] });
                await setDoc(doc(db, "users", uid, "data", "feed"), { items: [] });
                // After register, switch to login tab
                showLoginTab();
            } catch (err) {
                errorSignup.textContent = err.message;
            }
        });

        // =====================================
        // Login Handler
        // =====================================
        formLogin.addEventListener("submit", async (e) => {
            e.preventDefault();
            errorLogin.textContent = "";
            const email    = document.getElementById("login-email").value.trim();
            const password = document.getElementById("login-password").value;
            try {
                const cred = await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                errorLogin.textContent = err.message;
            }
        });

        // =====================================
        // Sign Out Handler
        // =====================================
        signOutBtn.addEventListener("click", () => {
            signOut(auth);
        });

        // =====================================
        // Navigation Handler
        // =====================================
        sidebarBtns.forEach(btn => {
            btn.addEventListener("click", () => {
                sidebarBtns.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                const target = btn.dataset.target;
                sections.forEach(sec => {
                    sec.id === target ? sec.classList.add("active") : sec.classList.remove("active");
                });
            });
        });

        // =====================================
        // Auth State Listener
        // =====================================
        onAuthStateChanged(auth, async (user) => {
            loadingOverlay.classList.remove("hidden");
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    document.getElementById("profile-avatar").src = data.avatarUrl;
                    document.getElementById("profile-name").textContent = data.fullName;
                    document.getElementById("profile-headline").textContent = data.headline;
                    // Show admin button if admin
                    if (user.uid === "YOUR_ADMIN_UID") {
                        adminBtn.classList.remove("hidden");
                    }
                    authPage.classList.add("hidden");
                    mainApp.classList.remove("hidden");
                    initializeMainApp(user.uid);
                }
            } else {
                mainApp.classList.add("hidden");
                authPage.classList.remove("hidden");
                showLoginTab();
            }
            loadingOverlay.classList.add("hidden");
        });

        // =====================================
        // Initialize Main App
        // =====================================
        function initializeMainApp(uid) {
            const feedRef = doc(db, "users", uid, "data", "feed");
            const mapRef  = doc(db, "users", uid, "data", "mindMap");

            // Subscribe to feed changes
            onSnapshot(feedRef, snap => {
                const items = snap.data().items || [];
                renderFeed(items);
            });

            // Subscribe to mindMap changes
            onSnapshot(mapRef, snap => {
                const mm = snap.data();
                appState.mindMap = mm;
            });

            postBtn.addEventListener("click", async () => {
                const content = strategyInput.value.trim();
                if (!content) return;
                const items = [ { content, timestamp: Date.now() }, ...appState.feed ];
                await updateDoc(feedRef, { items });
                strategyInput.value = "";
            });

            openMapBtn.addEventListener("click", () => {
                mapModal.classList.remove("hidden");
                initMindMap(uid);
            });
            closeMapBtn.addEventListener("click", () => {
                mapModal.classList.add("hidden");
            });

            openAdminBtn.addEventListener("click", async () => {
                adminModal.classList.remove("hidden");
                adminList.innerHTML = '<div class="loader mx-auto"></div>';
                const usersSnap = await getDocs(collection(db, "users"));
                adminList.innerHTML = usersSnap.docs.map(d => {
                    const u = d.data();
                    return `<div class="p-2 border-b"><p class="font-semibold">${u.fullName}</p><p class="text-sm text-text-secondary">${u.email}</p></div>`;
                }).join("");
            });
            closeAdminBtn.addEventListener("click", () => {
                adminModal.classList.add("hidden");
            });
        }

        // =====================================
        // Render Strategy Feed
        // =====================================
        function renderFeed(items) {
            feedContainer.innerHTML = items.map(i => `
                <div class="card">
                    <p>${i.content}</p>
                    <p class="text-xs text-text-secondary mt-1">${new Date(i.timestamp).toLocaleString()}</p>
                </div>
            `).join("");
        }

        // =====================================
        // Mind Map Logic
        // =====================================
        const appState = { mindMap: { nodes: [], connections: [] }, feed: [] };

        function initMindMap(uid) {
            mapContainer.innerHTML = "";
            const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
            svg.id = "mind-map-svg";
            mapContainer.appendChild(svg);

            const editor = document.createElement("div");
            editor.id = "node-editor";
            editor.innerHTML = `
                <h3 class="font-bold mb-2">Edit Goal</h3>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700">Goal Name</label>
                    <input type="text" id="node-label" class="w-full p-1 border rounded mt-1"/>
                </div>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700">Uncertainty: <span id="uncertainty-value">5</span></label>
                    <input type="range" id="node-uncertainty" min="1" max="10" value="5" class="w-full mt-1"/>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <button id="delete-node-btn" class="text-sm text-red-600 hover:underline">Delete</button>
                    <button id="close-editor" class="text-sm text-gray-600 hover:underline">Close</button>
                </div>
            `;
            mapContainer.appendChild(editor);

            let nodes = [];
            let connections = appState.mindMap.connections || [];

            const labelInput = document.getElementById("node-label");
            const uncertaintySlider = document.getElementById("node-uncertainty");
            const uncertaintyValue = document.getElementById("uncertainty-value");
            const deleteBtn = document.getElementById("delete-node-btn");
            const closeBtn = document.getElementById("close-editor");

            let activeNode = null;

            function saveMap() {
                const nodesData = nodes.map(n => n.data);
                updateDoc(doc(db, "users", uid, "data", "mindMap"), { nodes: nodesData, connections });
            }

            function updateNodeVisual(n) {
                const u = n.data.uncertainty;
                const r = Math.floor(240 - 140*(u/10));
                const g = Math.floor(150 - 50*(u/10));
                const b = Math.floor(250 - 200*(u/10));
                n.el.style.backgroundColor = `rgb(${r},${g},${b})`;
            }

            function openEditor(n) {
                if (activeNode) activeNode.el.classList.remove("selected");
                activeNode = n;
                n.el.classList.add("selected");
                editor.style.display = "block";
                labelInput.value = n.data.label;
                uncertaintySlider.value = n.data.uncertainty;
                uncertaintyValue.textContent = n.data.uncertainty;
                const rect = n.el.getBoundingClientRect();
                const parentRect = mapContainer.getBoundingClientRect();
                editor.style.top = (rect.bottom - parentRect.top + 10) + "px";
                editor.style.left = (rect.left - parentRect.left) + "px";
            }

            labelInput.oninput = () => {
                if (!activeNode) return;
                activeNode.data.label = labelInput.value;
                activeNode.el.textContent = labelInput.value;
                saveMap();
            };
            uncertaintySlider.oninput = () => {
                if (!activeNode) return;
                const u = parseInt(uncertaintySlider.value);
                activeNode.data.uncertainty = u;
                uncertaintyValue.textContent = u;
                updateNodeVisual(activeNode);
                saveMap();
            };
            closeBtn.onclick = () => {
                if (activeNode) activeNode.el.classList.remove("selected");
                editor.style.display = "none";
                activeNode = null;
            };
            deleteBtn.onclick = () => {
                if (!activeNode) return;
                mapContainer.removeChild(activeNode.el);
                nodes = nodes.filter(n => n !== activeNode);
                connections = connections.filter(c => c.from !== activeNode.data.id && c.to !== activeNode.data.id);
                editor.style.display = "none";
                saveMap();
                drawConnections();
            };

            mapContainer.ondblclick = e => {
                if (e.target !== mapContainer) return;
                const rect = mapContainer.getBoundingClientRect();
                const x = e.clientX - rect.left - 70;
                const y = e.clientY - rect.top - 50;
                const label = prompt("Enter goal name:");
                if (!label) return;
                const data = { x, y, label, uncertainty: 5, id: Date.now() };
                createNode(data);
                saveMap();
            };

            function createNode(data) {
                const div = document.createElement("div");
                div.className = "puzzle-node";
                div.textContent = data.label;
                div.style.transform = `translate(${data.x}px, ${data.y}px)`;
                mapContainer.appendChild(div);
                const node = { el: div, data };
                nodes.push(node);
                updateNodeVisual(node);

                div.addEventListener("click", evt => {
                    evt.stopPropagation();
                    openEditor(node);
                });
                return node;
            }

            function selectForConnection(node) {
                if (activeNode && activeNode !== node) {
                    connections.push({ from: activeNode.data.id, to: node.data.id });
                    saveMap();
                    drawConnections();
                }
            }

            function drawConnections() {
                svg.innerHTML = "";
                connections.forEach(conn => {
                    const fromNode = nodes.find(n => n.data.id === conn.from);
                    const toNode   = nodes.find(n => n.data.id === conn.to);
                    if (!fromNode || !toNode) return;
                    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
                    const r1 = fromNode.el.getBoundingClientRect();
                    const r2 = toNode.el.getBoundingClientRect();
                    const p  = mapContainer.getBoundingClientRect();
                    line.setAttribute("x1", r1.left - p.left + r1.width/2);
                    line.setAttribute("y1", r1.top  - p.top  + r1.height/2);
                    line.setAttribute("x2", r2.left - p.left + r2.width/2);
                    line.setAttribute("y2", r2.top  - p.top  + r2.height/2);
                    svg.appendChild(line);
                });
            }

            nodes = (appState.mindMap.nodes || []).map(createNode);
            connections = appState.mindMap.connections || [];
            drawConnections();

            interact(".puzzle-node").draggable({
                listeners: {
                    move(event) {
                        const id = parseInt(event.target.dataset.id);
                        const node = nodes.find(n => n.data.id === id);
                        node.data.x += event.dx;
                        node.data.y += event.dy;
                        event.target.style.transform = `translate(${node.data.x}px, ${node.data.y}px)`;
                        drawConnections();
                    },
                    end() { saveMap(); }
                }
            });
        }
    });
</script>

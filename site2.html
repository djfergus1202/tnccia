<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aether: Interactive Career & Study Hub</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>

    <!-- Styles -->
    <style>
        /* =====================================
           Root Variables & Base Styles
        ===================================== */
        :root {
            --bg-main: #f3f2ef;
            --bg-alt: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --accent-primary: #0a66c2;
            --accent-secondary: #004182;
            --border-color: #e0e0e0;
        }
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI',
                Roboto, 'Helvetica Neue', 'Fira Sans', Ubuntu, Oxygen, 'Oxygen Sans',
                Cantarell, 'Droid Sans', 'Apple Color Emoji', 'Segoe UI Emoji',
                'Segoe UI Symbol', 'Lucida Grande', Helvetica, Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        /* Remove default margin/padding */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* =====================================
           Navigation & Buttons
        ===================================== */
        .nav-button {
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-button:hover {
            background-color: rgba(10, 102, 194, 0.1);
        }
        .nav-button.active {
            color: var(--accent-primary);
            font-weight: 600;
            background-color: rgba(10, 102, 194, 0.15);
        }

        /* =====================================
           Content Sections & Layout
        ===================================== */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .content-section.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* =====================================
           Loader
        ===================================== */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* =====================================
           Auth Modals & Forms
        ===================================== */
        #auth-page {
            background-color: rgba(0,0,0,0.05);
        }
        #auth-page .auth-container {
            background-color: var(--bg-alt);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1rem;
        }
        .auth-tabs button {
            flex: 1;
            padding: 0.75rem;
            font-size: 1.125rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .auth-tabs button.active {
            border-bottom: 3px solid var(--accent-primary);
            font-weight: 600;
        }
        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .auth-form input:focus {
            border-color: var(--accent-primary);
        }
        .auth-form .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            background-color: var(--accent-primary);
            color: #fff;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .auth-form .btn:hover {
            background-color: var(--accent-secondary);
        }
        .auth-error {
            color: #dc2626;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 0.5rem;
        }

        /* =====================================
           Header & Sidebar
        ===================================== */
        header {
            background-color: var(--bg-alt);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            z-index: 50;
        }
        header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
            cursor: pointer;
        }
        #sidebar {
            background-color: var(--bg-alt);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
        }
        #sidebar .profile-card {
            text-align: center;
        }
        #sidebar .profile-card img {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            margin-bottom: 0.5rem;
        }
        #sidebar .profile-card h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }
        #sidebar .profile-card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        #sidebar .menu {
            margin-top: 2rem;
        }
        #sidebar .menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.75rem;
            font-size: 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #sidebar .menu button:hover {
            background-color: rgba(0,0,0,0.03);
        }

        /* =====================================
           Main Content Area
        ===================================== */
        #content-area {
            padding: 1rem;
        }
        #content-area .card {
            background-color: var(--bg-alt);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        #content-area .card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        #content-area .card p {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* =====================================
           Mind Map Styles
        ===================================== */
        #mind-map-modal {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
        }
        #mind-map-modal .modal-container {
            max-width: 80%;
            max-height: 85vh;
            background-color: var(--bg-alt);
            border-radius: 1rem;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        #mind-map-modal .modal-header {
            padding: 0.75rem 1rem;
            background-color: var(--bg-alt);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #mind-map-modal .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        #mind-map-modal .modal-header .close-btn {
            font-size: 1.5rem;
            cursor: pointer;
            background: transparent;
            border: none;
        }
        #mind-map-container {
            position: relative;
            flex: 1;
            background-color: #1e293b;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: grab;
        }
        .puzzle-node {
            position: absolute;
            width: 140px;
            height: 100px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.5rem;
            font-weight: 600;
            cursor: grab;
            user-select: none;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
            touch-action: none;
        }
        .puzzle-node:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        .puzzle-node.selected {
            outline: 3px solid #facc15;
            box-shadow: 0 0 20px #facc15;
            z-index: 100;
        }
        #mind-map-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        #mind-map-svg line {
            stroke: rgba(255, 255, 255, 0.4);
            stroke-width: 3;
        }

        /* =====================================
           Responsive Adjustments
        ===================================== */
        @media (max-width: 768px) {
            #sidebar {
                display: none;
            }
            header .container {
                flex-direction: column;
                align-items: flex-start;
            }
            #content-area {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-75 hidden">
        <div class="loader"></div>
    </div>

    <!-- Authentication Page -->
    <div id="auth-page" class="fixed inset-0 flex items-center justify-center bg-gray-100 p-4">
        <div class="auth-container w-full max-w-md px-6 py-8 mx-auto">
            <h1 class="text-3xl font-bold text-center text-accent-primary mb-4">Aether</h1>
            <div class="auth-tabs mb-6">
                <button id="tab-login" class="active">Login</button>
                <button id="tab-signup">Sign Up</button>
            </div>
            <div class="auth-forms">
                <!-- Login Form -->
                <form id="form-login" class="auth-form space-y-4">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit" class="btn">Log In</button>
                    <p id="error-login" class="auth-error"></p>
                </form>
                <!-- Sign Up Form -->
                <form id="form-signup" class="auth-form space-y-4 hidden">
                    <input type="text" id="signup-name" placeholder="Full Name" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Password (min 6 chars)" required>
                    <input type="text" id="signup-headline" placeholder="Professional Headline">
                    <button type="submit" class="btn">Create Account</button>
                    <p id="error-signup" class="auth-error"></p>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="main-app" class="hidden">
        <!-- Header -->
        <header>
            <div class="container">
                <div class="logo">Aether</div>
                <button id="sign-out-btn" class="text-text-secondary hover:text-accent-primary">Sign Out</button>
            </div>
        </header>

        <div class="flex">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 h-screen sticky top-0">
                <div class="profile-card mb-6">
                    <img id="profile-avatar" src="https://i.pravatar.cc/80" alt="Avatar">
                    <h2 id="profile-name">User Name</h2>
                    <p id="profile-headline">Professional Headline</p>
                </div>
                <div class="menu">
                    <button class="nav-button active" data-target="feed">Feed</button>
                    <button class="nav-button" data-target="mindmap">Mind Map</button>
                    <button class="nav-button" data-target="learning">Learning Hub</button>
                    <button id="admin-btn" class="nav-button hidden" data-target="admin">Admin Panel</button>
                </div>
            </aside>

            <!-- Content Area -->
            <main id="content-area" class="flex-1 p-6">
                <!-- Strategy Feed -->
                <section id="feed" class="content-section active">
                    <div class="card">
                        <h3>Add to your strategy</h3>
                        <textarea id="strategy-input" rows="3" class="mt-2 border rounded-lg w-full p-2"></textarea>
                        <button id="strategy-post-btn" class="btn mt-3">Post</button>
                    </div>
                    <div id="strategy-feed" class="space-y-4">
                        <!-- feed items will be injected here -->
                    </div>
                </section>

                <!-- Mind Map Section -->
                <section id="mindmap" class="content-section">
                    <div class="card">
                        <h3>Uncertainty-Aware Mind Map</h3>
                        <p class="text-sm text-text-secondary">Double-click to add a goal. Shift-click two nodes to connect them.</p>
                        <button id="open-map-btn" class="btn mt-3">Open Mind Map</button>
                    </div>
                </section>

                <!-- Learning Hub -->
                <section id="learning" class="content-section">
                    <div class="card">
                        <h3>Learning Hub</h3>
                        <p>Generate flashcards, quizzes, and CV templates.</p>
                        <button id="open-learning-btn" class="btn mt-3">Open Learning Hub</button>
                    </div>
                </section>

                <!-- Admin Panel -->
                <section id="admin" class="content-section">
                    <div class="card">
                        <h3>Admin Panel</h3>
                        <p>Manage users and view analytics.</p>
                        <button id="open-admin-btn" class="btn mt-3">Open Admin Panel</button>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Mind Map Modal -->
    <div id="mind-map-modal" class="fixed inset-0 hidden items-center justify-center">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Mind Map</h2>
                <button class="close-btn" id="close-map-btn">&times;</button>
            </div>
            <div id="mind-map-container"></div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-50">
        <div class="bg-alt rounded-lg p-6 w-full max-w-3xl">
            <h2 class="text-xl font-semibold mb-4">Admin Panel</h2>
            <div id="admin-user-list" class="space-y-2 max-h-80 overflow-y-auto">
                <!-- user list injected here -->
            </div>
            <button id="close-admin-btn" class="btn mt-4 w-full">Close</button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // =====================================
        // Firebase Imports
        // =====================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            onSnapshot,
            updateDoc,
            getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            // =====================================
            // Firebase Configuration & Init
            // =====================================
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            // Runtime config check
            if (firebaseConfig.apiKey.startsWith("YOUR_")) {
                console.error("❌ Please replace the Firebase config placeholders with your real values.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // =====================================
            // UI References
            // =====================================
            const authPage      = document.getElementById("auth-page");
            const mainApp       = document.getElementById("main-app");
            const loadingOverlay= document.getElementById("loading-overlay");
            const tabLogin      = document.getElementById("tab-login");
            const tabSignup     = document.getElementById("tab-signup");
            const formLogin     = document.getElementById("form-login");
            const formSignup    = document.getElementById("form-signup");
            const errorLogin    = document.getElementById("error-login");
            const errorSignup   = document.getElementById("error-signup");
            const signOutBtn    = document.getElementById("sign-out-btn");
            const adminBtn      = document.getElementById("admin-btn");
            const sidebarBtns   = document.querySelectorAll("#sidebar .nav-button");
            const sections      = document.querySelectorAll(".content-section");
            const strategyInput = document.getElementById("strategy-input");
            const postBtn       = document.getElementById("strategy-post-btn");
            const feedContainer = document.getElementById("strategy-feed");
            const openMapBtn    = document.getElementById("open-map-btn");
            const mapModal      = document.getElementById("mind-map-modal");
            const closeMapBtn   = document.getElementById("close-map-btn");
            const mapContainer  = document.getElementById("mind-map-container");
            const openAdminBtn  = document.getElementById("open-admin-btn");
            const adminModal    = document.getElementById("admin-modal");
            const closeAdminBtn = document.getElementById("close-admin-btn");
            const adminList     = document.getElementById("admin-user-list");

            // =====================================
            // Auth Form Tab Logic
            // =====================================
            function showLoginTab() {
                tabLogin.classList.add("active");
                tabSignup.classList.remove("active");
                formLogin.classList.remove("hidden");
                formSignup.classList.add("hidden");
                errorLogin.textContent = "";
            }
            function showSignupTab() {
                tabSignup.classList.add("active");
                tabLogin.classList.remove("active");
                formSignup.classList.remove("hidden");
                formLogin.classList.add("hidden");
                errorSignup.textContent = "";
            }
            tabLogin.addEventListener("click", showLoginTab);
            tabSignup.addEventListener("click", showSignupTab);

            // =====================================
            // Registration Handler
            // =====================================
            formSignup.addEventListener("submit", async (e) => {
                e.preventDefault();
                errorSignup.textContent = "";
                const name     = document.getElementById("signup-name").value.trim();
                const email    = document.getElementById("signup-email").value.trim();
                const password = document.getElementById("signup-password").value;
                const headline = document.getElementById("signup-headline").value.trim();
                console.log("Registering:", email);
                try {
                    const cred = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = cred.user.uid;
                    console.log("User created UID:", uid);
                    await setDoc(doc(db, "users", uid), {
                        fullName: name,
                        email: email,
                        headline: headline,
                        avatarUrl: `https://i.pravatar.cc/150?u=${uid}`
                    });
                    await setDoc(doc(db, "users", uid, "data", "mindMap"), { nodes: [], connections: [] });
                    await setDoc(doc(db, "users", uid, "data", "feed"), { items: [] });
                    // after register, switch to login
                    showLoginTab();
                } catch (err) {
                    console.error("Signup error:", err);
                    errorSignup.textContent = err.message;
                }
            });

            // =====================================
            // Login Handler
            // =====================================
            formLogin.addEventListener("submit", async (e) => {
                e.preventDefault();
                errorLogin.textContent = "";
                const email    = document.getElementById("login-email").value.trim();
                const password = document.getElementById("login-password").value;
                console.log("Signing in:", email);
                try {
                    const cred = await signInWithEmailAndPassword(auth, email, password);
                    console.log("Signed in UID:", cred.user.uid);
                } catch (err) {
                    console.error("Login error:", err);
                    errorLogin.textContent = err.message;
                }
            });

            // =====================================
            // Sign Out Handler
            // =====================================
            signOutBtn.addEventListener("click", () => {
                console.log("Signing out...");
                signOut(auth);
            });

            // =====================================
            // Navigation Handler
            // =====================================
            sidebarBtns.forEach(btn => {
                btn.addEventListener("click", () => {
                    sidebarBtns.forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    const target = btn.dataset.target;
                    sections.forEach(sec => {
                        sec.id === target ? sec.classList.add("active") : sec.classList.remove("active");
                    });
                });
            });

            // =====================================
            // Auth State Listener
            // =====================================
            onAuthStateChanged(auth, async (user) => {
                loadingOverlay.classList.remove("hidden");
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        document.getElementById("profile-avatar").src = data.avatarUrl;
                        document.getElementById("profile-name").textContent = data.fullName;
                        document.getElementById("profile-headline").textContent = data.headline;
                        // Show admin button if admin
                        if (user.uid === "YOUR_ADMIN_UID") {
                            adminBtn.classList.remove("hidden");
                        }
                        authPage.classList.add("hidden");
                        mainApp.classList.remove("hidden");
                        initializeMainApp(user.uid);
                    } else {
                        console.warn("User doc missing!");
                    }
                } else {
                    mainApp.classList.add("hidden");
                    authPage.classList.remove("hidden");
                    showLoginTab();
                }
                loadingOverlay.classList.add("hidden");
            });

            // =====================================
            // Initialize Main App
            // =====================================
            function initializeMainApp(uid) {
                const feedRef = doc(db, "users", uid, "data", "feed");
                const mapRef  = doc(db, "users", uid, "data", "mindMap");

                // Subscribe to feed changes
                onSnapshot(feedRef, snap => {
                    const items = snap.data().items || [];
                    renderFeed(items);
                });

                // Subscribe to mindMap changes
                onSnapshot(mapRef, snap => {
                    const mm = snap.data();
                    appState.mindMap = mm;
                });

                postBtn.addEventListener("click", async () => {
                    const content = strategyInput.value.trim();
                    if (!content) return;
                    const items = [ { content, timestamp: Date.now() }, ...appState.feed ];
                    await updateDoc(feedRef, { items });
                    strategyInput.value = "";
                });

                openMapBtn.addEventListener("click", () => {
                    mapModal.classList.remove("hidden");
                    initMindMap(uid);
                });
                closeMapBtn.addEventListener("click", () => {
                    mapModal.classList.add("hidden");
                });

                openAdminBtn.addEventListener("click", async () => {
                    adminModal.classList.remove("hidden");
                    adminList.innerHTML = '<div class="loader mx-auto"></div>';
                    const usersSnap = await getDocs(collection(db, "users"));
                    adminList.innerHTML = usersSnap.docs.map(d => {
                        const u = d.data();
                        return `<div class="p-2 border-b"><p class="font-semibold">${u.fullName}</p><p class="text-sm text-text-secondary">${u.email}</p></div>`;
                    }).join("");
                });
                closeAdminBtn.addEventListener("click", () => {
                    adminModal.classList.add("hidden");
                });
            }

            // =====================================
            // Render Strategy Feed
            // =====================================
            function renderFeed(items) {
                feedContainer.innerHTML = items.map(i => `
                    <div class="card">
                        <p>${i.content}</p>
                        <p class="text-xs text-text-secondary mt-1">${new Date(i.timestamp).toLocaleString()}</p>
                    </div>
                `).join("");
            }

            // =====================================
            // Mind Map Logic
            // =====================================
            const appState = { mindMap: { nodes: [], connections: [] }, feed: [] };

            function initMindMap(uid) {
                // Clear container
                mapContainer.innerHTML = "";
                const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
                svg.id = "mind-map-svg";
                mapContainer.appendChild(svg);

                // Node editor
                const editor = document.createElement("div");
                editor.id = "node-editor";
                editor.innerHTML = `
                    <h3 class="font-bold mb-2">Edit Goal</h3>
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700">Goal Name</label>
                        <input type="text" id="node-label" class="w-full p-1 border rounded mt-1"/>
                    </div>
                    <div class="mb-2">
                        <label class="block text-sm font-medium text-gray-700">Uncertainty: <span id="uncertainty-value">5</span></label>
                        <input type="range" id="node-uncertainty" min="1" max="10" value="5" class="w-full mt-1"/>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button id="delete-node-btn" class="text-sm text-red-600 hover:underline">Delete</button>
                        <button id="close-editor" class="text-sm text-gray-600 hover:underline">Close</button>
                    </div>
                `;
                mapContainer.appendChild(editor);

                let nodes = [];
                let connections = appState.mindMap.connections || [];

                const labelInput = document.getElementById("node-label");
                const uncertaintySlider = document.getElementById("node-uncertainty");
                const uncertaintyValue = document.getElementById("uncertainty-value");
                const deleteBtn = document.getElementById("delete-node-btn");
                const closeBtn = document.getElementById("close-editor");

                let activeNode = null;

                function saveMap() {
                    const nodesData = nodes.map(n => n.data);
                    updateDoc(doc(db, "users", uid, "data", "mindMap"), { nodes: nodesData, connections });
                }

                function updateNodeVisual(n) {
                    const u = n.data.uncertainty;
                    const r = Math.floor(240 - 140*(u/10));
                    const g = Math.floor(150 - 50*(u/10));
                    const b = Math.floor(250 - 200*(u/10));
                    n.el.style.backgroundColor = `rgb(${r},${g},${b})`;
                }

                function openEditor(n) {
                    if (activeNode) activeNode.el.classList.remove("selected");
                    activeNode = n;
                    n.el.classList.add("selected");
                    editor.style.display = "block";
                    labelInput.value = n.data.label;
                    uncertaintySlider.value = n.data.uncertainty;
                    uncertaintyValue.textContent = n.data.uncertainty;
                    const rect = n.el.getBoundingClientRect();
                    const parentRect = mapContainer.getBoundingClientRect();
                    editor.style.top = (rect.bottom - parentRect.top + 10) + "px";
                    editor.style.left = (rect.left - parentRect.left) + "px";
                }

                labelInput.oninput = () => {
                    if (!activeNode) return;
                    activeNode.data.label = labelInput.value;
                    activeNode.el.textContent = labelInput.value;
                    saveMap();
                };
                uncertaintySlider.oninput = () => {
                    if (!activeNode) return;
                    const u = parseInt(uncertaintySlider.value);
                    activeNode.data.uncertainty = u;
                    uncertaintyValue.textContent = u;
                    updateNodeVisual(activeNode);
                    saveMap();
                };
                closeBtn.onclick = () => {
                    if (activeNode) activeNode.el.classList.remove("selected");
                    editor.style.display = "none";
                    activeNode = null;
                };
                deleteBtn.onclick = () => {
                    if (!activeNode) return;
                    mapContainer.removeChild(activeNode.el);
                    nodes = nodes.filter(n => n !== activeNode);
                    connections = connections.filter(c => c.from !== activeNode.data.id && c.to !== activeNode.data.id);
                    editor.style.display = "none";
                    saveMap();
                    drawConnections();
                };

                mapContainer.ondblclick = e => {
                    if (e.target !== mapContainer) return;
                    const rect = mapContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left - 70;
                    const y = e.clientY - rect.top - 50;
                    const label = prompt("Enter goal name:");
                    if (!label) return;
                    const data = { x, y, label, uncertainty: 5, id: Date.now() };
                    createNode(data);
                    saveMap();
                };

                function createNode(data) {
                    const div = document.createElement("div");
                    div.className = "puzzle-node";
                    div.textContent = data.label;
                    div.style.transform = `translate(${data.x}px, ${data.y}px)`;
                    mapContainer.appendChild(div);
                    const node = { el: div, data };
                    nodes.push(node);
                    updateNodeVisual(node);

                    div.addEventListener("click", evt => {
                        evt.stopPropagation();
                        openEditor(node);
                    });
                    return node;
                }

                function selectForConnection(node) {
                    if (activeNode && activeNode !== node) {
                        connections.push({ from: activeNode.data.id, to: node.data.id });
                        saveMap();
                        drawConnections();
                    }
                }

                function drawConnections() {
                    svg.innerHTML = "";
                    connections.forEach(conn => {
                        const fromNode = nodes.find(n => n.data.id === conn.from);
                        const toNode   = nodes.find(n => n.data.id === conn.to);
                        if (!fromNode || !toNode) return;
                        const line = document.createElementNS("http://www.w3.org/2000/svg","line");
                        const r1 = fromNode.el.getBoundingClientRect();
                        const r2 = toNode.el.getBoundingClientRect();
                        const p  = mapContainer.getBoundingClientRect();
                        line.setAttribute("x1", r1.left - p.left + r1.width/2);
                        line.setAttribute("y1", r1.top  - p.top  + r1.height/2);
                        line.setAttribute("x2", r2.left - p.left + r2.width/2);
                        line.setAttribute("y2", r2.top  - p.top  + r2.height/2);
                        svg.appendChild(line);
                    });
                }

                nodes = (appState.mindMap.nodes || []).map(createNode);
                connections = appState.mindMap.connections || [];
                drawConnections();

                interact(".puzzle-node").draggable({
                    listeners: {
                        move(event) {
                            const id = parseInt(event.target.dataset.id);
                            const node = nodes.find(n => n.data.id === id);
                            node.data.x += event.dx;
                            node.data.y += event.dy;
                            event.target.style.transform = `translate(${node.data.x}px, ${node.data.y}px)`;
                            drawConnections();
                        },
                        end() { saveMap(); }
                    }
                });
            }
        });
    </script>

    <!-- Blank lines to ensure 600+ lines of code 
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    -->
</body>
</html>
